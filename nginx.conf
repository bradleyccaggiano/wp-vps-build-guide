user                  www-data;
worker_processes      auto;
worker_rlimit_nofile  8192;
pid                   /run/nginx.pid;
error_log             /var/log/error.log warn;

events {
	worker_connections  8096;
	multi_accept        on;
	use                 epoll;
}

http {
	# Basic Settings
	sendfile                       on;
	tcp_nopush                     on;
	tcp_nodelay                    on;
	types_hash_max_size            2048;
	server_tokens                  off;
	server_names_hash_bucket_size  64;
	include                        /etc/nginx/mime.types;
	default_type                   application/octet-stream;

	# Update charset_types due to updated mime.types
	charset_types  text/xml
	               text/plain
	               text/vnd.wap.wml
	               application/x-javascript
	               application/rss+xml
	               text/css
	               application/javascript
	               application/json;

	# Buffers
	client_body_buffer_size      10K;
	client_header_buffer_size    1k;
	client_max_body_size         10m;
	large_client_header_buffers  2 1k;

	# Timeouts
	client_body_timeout        12;
	client_header_timeout      12;
	keepalive_timeout          20;
	send_timeout               10;
	reset_timedout_connection  on;

	# SSL Settings
	ssl_protocols              TLSv1 TLSv1.1 TLSv1.2;
	ssl_prefer_server_ciphers  on;

	# Logging Settings
	access_log  /var/log/nginx/access.log;
	error_log   /var/log/nginx/error.log;

	# Gzip Settings
	gzip               on;
	gzip_disable       "MSIE [1-6]\.";
	gzip_vary          on;
	gzip_proxied       any;
	gzip_comp_level    5;
	gzip_min_length    256;
	gzip_buffers       16 8k;
	gzip_http_version  1.1;
	gzip_types         application/atom+xml
	                   application/javascript
	                   application/json
	                   application/ld+json
	                   application/manifest+json
	                   application/rdf+xml
	                   application/rss+xml
	                   application/schema+json
	                   application/vnd.geo+json
	                   application/vnd.ms-fontobject
	                   application/x-font-ttf
	                   application/x-javascript
	                   application/x-web-app-manifest+json
	                   application/xhtml+xml
	                   application/xml
	                   font/eot
	                   font/opentype
	                   image/bmp
	                   image/svg+xml
	                   image/vnd.microsoft.icon
	                   image/x-icon
	                   text/cache-manifest
	                   text/css
	                   text/javascript
	                   text/plain
	                   text/vcard
	                   text/vnd.rim.location.xloc
	                   text/vtt
	                   text/x-component
	                   text/x-cross-domain-policy
	                   text/xml;

	# FastCGI Caching
	fastcgi_cache_path            /dev/shm/nginx levels=1:2 
	                              keys_zone=fastCgiCache:16m
	                              max_size=1024m inactive=60m;
	fastcgi_cache_key             "$scheme$request_method$host$request_uri";
	fastcgi_cache_use_stale       error timeout invalid_header http_500;
	fastcgi_ignore_headers        Cache-Control Expires Set-Cookie;
	fastcgi_buffers               256 16k;
	fastcgi_buffer_size           128k;
	fastcgi_connect_timeout       3s;
	fastcgi_send_timeout          120s;
	fastcgi_read_timeout          120s;
	fastcgi_busy_buffers_size     256k;
	fastcgi_temp_file_write_size  256k;

	# Filehandle Caching
	open_file_cache           max=2000 inactive=20s;
	open_file_cache_valid     60s;
	open_file_cache_min_uses  2;
	open_file_cache_errors    off;

	# Global Pagespeed Options
	pagespeed UsePerVhostStatistics     on;
	pagespeed MessageBufferSize         100000;
	pagespeed StatisticsPath            /ngx_pagespeed_statistics;
	pagespeed GlobalStatisticsPath      /ngx_pagespeed_global_statistics;
	pagespeed MessagesPath              /ngx_pagespeed_message;
	pagespeed ConsolePath               /pagespeed_console;
	pagespeed AdminPath                 /pagespeed_admin;
	pagespeed GlobalAdminPath           /pagespeed_global_admin;
	pagespeed FetchHttps                enable,allow_self_signed;
	pagespeed SslCertDirectory          /etc/nginx/ssl;
    pagespeed FileCachePath             "/var/cache/pagespeed/";
    pagespeed FileCacheSizeKb           102400;
    pagespeed FileCacheCleanIntervalMs  3600000;
    pagespeed FileCacheInodeLimit       500000;

	# Prevent brute force attacks
	limit_req_zone    $binary_remote_addr zone=one:10m rate=1r/s;
	limit_req_status  444;

	# Virtual Host Configs
	include	 /etc/nginx/conf.d/*.conf;
	include	 /etc/nginx/sites-enabled/*;
}
